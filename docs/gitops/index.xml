<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Portefaix – Gitops</title><link>/docs/gitops/</link><description>Recent content in Gitops on Portefaix</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><atom:link href="/docs/gitops/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: FluxCD</title><link>/docs/gitops/gitops-fluxcd/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/gitops/gitops-fluxcd/</guid><description>
&lt;p>&lt;a href="https://www.weave.works/technologies/gitops/">Gitops&lt;/a> model used is &lt;a href="https://toolkit.fluxcd.io/">Flux v2&lt;/a>&lt;/p>
&lt;p>&lt;img src="/docs/images/gitops-toolkit.png"
alt="Flux v2"
class="mt-3 mb-3 border border-info rounded">&lt;/p>
&lt;h2 id="organization">Organization&lt;/h2>
&lt;p>Manifests files :&lt;/p>
&lt;ul>
&lt;li>&lt;code>kubernetes/base&lt;/code> directory contains manifests for all components&lt;/li>
&lt;li>&lt;code>kubernetes/overlays/**&lt;/code> directory contains &lt;a href="https://kustomize.io/">Kustomize&lt;/a> overlays&lt;/li>
&lt;/ul>
&lt;p>Flux components are deployed for each cluster on &lt;code>clusters/&amp;lt;CLOUD&amp;gt;/&amp;lt;ENV&amp;gt;/&lt;/code> :&lt;/p>
&lt;ul>
&lt;li>&lt;code>clusters/&amp;lt;CLOUD&amp;gt;/&amp;lt;ENV&amp;gt;/flux-system&lt;/code> : Flux core components&lt;/li>
&lt;li>&lt;code>clusters/&amp;lt;CLOUD&amp;gt;/&amp;lt;ENV&amp;gt;/*.yaml&lt;/code> : &lt;a href="https://toolkit.fluxcd.io/components/kustomize/kustomization/">Flux Kustomization&lt;/a> files for components&lt;/li>
&lt;/ul>
&lt;h2 id="bootstrap">Bootstrap&lt;/h2>
&lt;h3 id="fluxcd">FluxCD&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make fluxcd-bootstrap &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;environment&amp;gt; &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;cloud provider&amp;gt; &lt;span style="color:#000">BRANCH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;git branch to use&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="secrets">Secrets&lt;/h3>
&lt;p>&lt;a href="https://github.com/mozilla/sops">Sops&lt;/a> is used to manage secrets.&lt;/p>
&lt;p>Create for each cloud provider and environment an &lt;a href="https://age-encryption.org/">Age&lt;/a> key. Store it into:&lt;/p>
&lt;p>&lt;code>.secrets/&amp;lt;CLOUD_PROVIDER&amp;gt;/&amp;lt;ENV&amp;gt;/age/age.agekey&lt;/code>&lt;/p>
&lt;p>Put your sensitive data into the directory &lt;code>.secrets&lt;/code> or &lt;code>.secrets/&amp;lt;CLOUD_PROVIDER&amp;gt;/&amp;lt;ENV&amp;gt;/&amp;lt;APPLICATION&amp;gt;&lt;/code>&lt;/p>
&lt;p>Then deploy the Age key into a Kubernetes secret:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make sops-age-secret &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;CLOUD_PROVIDER&amp;gt; &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;ENV&amp;gt; &lt;span style="color:#000">NAMESPACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>flux-system
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="stacks">Stacks&lt;/h3>
&lt;p>You can list stack installed:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ kubectl -n flux-system get kustomization -l &lt;span style="color:#4e9a06">&amp;#34;app.kubernetes.io/component=portefaix-stack&amp;#34;&lt;/span>
NAME AGE READY STATUS
core 107m True Applied revision: feat/weave-gitops/2ea4d23f1ae31bfb6afbe57a4662b5990dcf3307
observability 109m True Applied revision: feat/weave-gitops/2ea4d23f1ae31bfb6afbe57a4662b5990dcf3307
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And Helm releases:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ helm list -A
NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION
alertmanager-mixin monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:51.540267795 +0000 UTC deployed alertmanager-mixin-0.6.0 0.23.0
kube-prometheus-stack monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:52.701498295 +0000 UTC deployed kube-prometheus-stack-35.0.3 0.56.0
kube-state-metrics-mixin monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:52.285323133 +0000 UTC deployed kube-state-metrics-mixin-0.10.0 2.2.4
kubernetes-mixin monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:52.528376605 +0000 UTC deployed kubernetes-mixin-0.8.0 0.8.0
kyverno flux-system &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 09:00:31.649605165 +0000 UTC deployed kyverno-crds-v2.0.3 v1.4.3
metrics-server kube-system &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:41.851963826 +0000 UTC failed metrics-server-3.8.2 0.6.1
prometheus-mixin monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:53.019370201 +0000 UTC deployed prometheus-mixin-0.10.0 2.31.1
prometheus-operator-mixin monitoring &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 10:57:53.815678548 +0000 UTC deployed prometheus-operator-mixin-0.8.0 0.52.1
weawe-gitops flux-system &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-08-08 07:49:32.97390968 +0000 UTC deployed weave-gitops-2.2.5 v0.9.1
&lt;/code>&lt;/pre>&lt;/div>&lt;img src="/docs/images/fluxcd-applications.png" alt="Flux-CD Applications" class="mt-3 mb-3 border border-info rounded">
&lt;img src="/docs/images/fluxcd-kustomization-details.png" alt="Details" class="mt-3 mb-3 border border-info rounded">
&lt;img src="/docs/images/fluxcd-kustomization-graph.png" alt="Graph" class="mt-3 mb-3 border border-info rounded">
&lt;h2 id="secrets-1">Secrets&lt;/h2>
&lt;h3 id="file">File&lt;/h3>
&lt;p>Create a Kubernetes secret file from sensitive file.&lt;/p>
&lt;p>Ex: for Thanos configuration :&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#000">❯ cat .secrets/aws/object-store.yaml&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">S3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">config&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">bucket&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">xxxxxxxxxxx&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">endpoint&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">s3.eu-west-3.amazonaws.com&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">region&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">eu-west-3&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make kubernetes-secret &lt;span style="color:#000">NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>thanos-object-storage &lt;span style="color:#000">NAMESPACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>monitoring &lt;span style="color:#000">FILE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>.secrets/aws/object-store.yaml &amp;gt; thanos-object-storage.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="encrypt">Encrypt&lt;/h3>
&lt;p>Encrypt the file using Sops:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make sops-encrypt &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>staging &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>aws &lt;span style="color:#000">FILE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>thanos-object-storage.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can now safely store this file into Git.&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ mv thanos-object-storage.yaml kubernetes/overlays/staging/monitoring/thanos/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="decrypt">Decrypt&lt;/h3>
&lt;p>Check you can decrypt the file:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make sops-decrypt &lt;span style="color:#000">FILE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>kubernetes/overlays/staging/monitoring/thanos/thanos-object-storage.yaml
apiVersion: v1
data:
object-store.yaml: xxxxxxxxxxx
kind: Secret
metadata:
creationTimestamp: null
name: thanos-object-storage
namespace: monitoring
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cicd">CI/CD&lt;/h2>
&lt;h3 id="age">AGE&lt;/h3>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">Work In Progress&lt;/h4>
&lt;/div>
&lt;h3 id="pgp">PGP&lt;/h3>
&lt;p>Generate a GPG key with OpenPGP without specifying a passphrase:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ gpg --full-generate-key
Real name: nlamirault
Email address: nlamirault@users.noreply.github.com
Comment:
You selected this USER-ID:
&lt;span style="color:#4e9a06">&amp;#34;nlamirault &amp;lt;nlamirault@users.noreply.github.com&amp;gt;&amp;#34;&lt;/span>
Change &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>N&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>ame, &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>C&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>omment, &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>E&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>mail or &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>O&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>kay/&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Q&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>uit? O
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Retrieve the GPG key ID:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ gpg --export-secret-keys &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span>--armor FC5BB3323309486AC8DA477CEC6421C7C33D2301
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Add this output into a Github Secret &lt;code>SOPS_GPG_KEY&lt;/code>.&lt;/p>
&lt;p>On the &lt;code>e2e&lt;/code> Github Action workflow, we create a Kubernetes secret &lt;code>sops-gpg&lt;/code>
which will be used by Flux.&lt;/p></description></item><item><title>Docs: ArgoCD</title><link>/docs/gitops/gitops-argocd/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/gitops/gitops-argocd/</guid><description>
&lt;img src="/docs/images/argocd_architecture.png" alt="Argo-CD" class="mt-3 mb-3 border border-info rounded">
&lt;h2 id="organization">Organization&lt;/h2>
&lt;ul>
&lt;li>&lt;code>gitops/argocd/bootstrap&lt;/code> : Argo-CD deployment&lt;/li>
&lt;li>&lt;code>gitops/argocd/stacks&lt;/code> : Portefaix stacks : Argo-CD projects and applications&lt;/li>
&lt;li>&lt;code>gitops/argocd/apps/&amp;lt;CLOUD&amp;gt;/&amp;lt;ENVIRONMENT&amp;gt;&lt;/code> : Argo-CD applications deployed into the Kubernetes cluster&lt;/li>
&lt;li>&lt;code>gitops/argocd/charts&lt;/code> : Helm charts configurations&lt;/li>
&lt;/ul>
&lt;p>To configure the Helm charts, we use YAML files :&lt;/p>
&lt;ul>
&lt;li>&lt;code>values.yaml&lt;/code>: common configuration to all Kubernetes cluster&lt;/li>
&lt;li>&lt;code>values-&amp;lt;CLOUD&amp;gt;-&amp;lt;ENVIRONMENT&amp;gt;.yaml&lt;/code> : configuration of the Helm chart for a Kubernetes cluster&lt;/li>
&lt;/ul>
&lt;h2 id="bootstrap">Bootstrap&lt;/h2>
&lt;h3 id="argo-cd">Argo-CD&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make argocd-bootstrap &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;environment&amp;gt; &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;cloud provider&amp;gt; &lt;span style="color:#000">CHOICE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>helm
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="stacks">Stacks&lt;/h3>
&lt;p>Install a stack into the cluster:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make argocd-stack-install &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;environment&amp;gt; &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;cloud provider&amp;gt; &lt;span style="color:#000">STACK&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&amp;lt;stack name&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;img src="/docs/images/argocd_stacks.png" alt="Argo-CD Stacks" class="mt-3 mb-3 border border-info rounded">
&lt;p>You can list stack installed:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ helm list -A
NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION
argo-cd argocd &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-06-08 07:40:20.039787662 +0200 CEST deployed argo-cd-1.0.0 4.5.0
core argocd &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-06-08 07:42:03.285558277 +0200 CEST deployed stack-0.1.0 0.1.0
system argocd &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 2022-06-08 07:41:21.749647011 +0200 CEST deployed stack-0.1.0 0.1.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Argo-CD applications installs others Argo-CD applications :&lt;/p>
&lt;img src="/docs/images/argocd_app_observability.png" alt="Argo-CD Observability" class="mt-3 mb-3 border border-info rounded">
&lt;img src="/docs/images/argocd_app_grafana.png" alt="Argo-CD Grafana" class="mt-3 mb-3 border border-info rounded">
&lt;p>Go to Argo-CD dashboard, you will see Argo-CD corresponding applications.&lt;/p>
&lt;p>You can list &lt;strong>Stack&lt;/strong> applications using the labels &lt;code>app.kubernetes.io/component: portefaix-stack&lt;/code>&lt;/p>
&lt;h2 id="secrets">Secrets&lt;/h2>
&lt;p>&lt;a href="https://github.com/bitnami-labs/sealed-secrets">sealed-secrets&lt;/a> is used to store secrets into Kubernetes.&lt;/p>
&lt;p>Fetch the certificate that you will use to encrypt your secrets, and store it into &lt;code>.secrets/&amp;lt;CLOUD&amp;gt;/&amp;lt;ENV&amp;gt;/sealed-secrets/cert.pem&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ kubeseal --fetch-cert --controller-name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>sealed-secrets -n kube-system &amp;gt; .secrets/aws/staging/sealed-secrets/cert.pm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create a SealedSecrets from a file :&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ make kubeseal-encrypt &lt;span style="color:#000">CLOUD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>aws &lt;span style="color:#000">ENV&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>staging &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> &lt;span style="color:#000">FILE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>.secrets/aws/staging/kube-prometheus-stack/object-store.yaml &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> &lt;span style="color:#000">NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>thanos-objstore-config &lt;span style="color:#000">NAMESPACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>monitoring &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> &amp;gt; ./gitops/argocd/apps/aws/staging/apps/thanos-objstore-config.yaml
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>